<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRã‚³ãƒ¼ãƒ‰æš—å·åŒ–ã‚·ã‚¹ãƒ†ãƒ  - ãƒ†ã‚¹ãƒˆç®¡ç†ç”»é¢</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .section h2 {
            color: #666;
            margin-top: 0;
        }

        .form-group {
            margin: 15px 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }

        button:hover {
            background: #3367d6;
        }

        button.secondary {
            background: #6c757d;
        }

        button.success {
            background: #28a745;
        }

        button.warning {
            background: #ffc107;
            color: #333;
        }

        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .qr-display {
            text-align: center;
            margin: 20px 0;
        }

        .qr-display canvas {
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ” QRã‚³ãƒ¼ãƒ‰æš—å·åŒ–ã‚·ã‚¹ãƒ†ãƒ  - ãƒ†ã‚¹ãƒˆç®¡ç†ç”»é¢</h1>

        <!-- 1. ç®¡ç†è€…è¨­å®šã¨ã‚­ãƒ¼ç”Ÿæˆ -->
        <div class="section">
            <h2>1. ç®¡ç†è€…è¨­å®šã¨ã‚­ãƒ¼ç”Ÿæˆ</h2>
            <div class="form-group">
                <label for="adminId">ç®¡ç†è€…ID:</label>
                <input type="text" id="adminId" value="ADMIN001" placeholder="ç®¡ç†è€…IDã‚’å…¥åŠ›">
            </div>
            <div class="form-group">
                <label for="eventId">ã‚¤ãƒ™ãƒ³ãƒˆID:</label>
                <input type="text" id="eventId" value="EVENT001" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’å…¥åŠ›">
            </div>
            <button onclick="generateEncryptionKey()">ğŸ”‘ æš—å·åŒ–ã‚­ãƒ¼ç”Ÿæˆ/å–å¾—</button>
            <button onclick="checkAdminSettings()" class="secondary">ğŸ“‹ ç¾åœ¨ã®è¨­å®šç¢ºèª</button>
            <div id="adminResult" class="result" style="display: none;"></div>
        </div>

        <!-- 2. QRãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆãƒ†ã‚¹ãƒˆ -->
        <div class="section">
            <h2>2. QRãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆãƒ†ã‚¹ãƒˆ</h2>
            <div class="form-group">
                <label for="testDocId">ãƒ†ã‚¹ãƒˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID:</label>
                <input type="text" id="testDocId" value="USER001" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID">
            </div>
            <button onclick="generateTestToken()">ğŸ¯ ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ</button>
            <button onclick="decryptTestToken()" class="secondary">ğŸ”“ ãƒˆãƒ¼ã‚¯ãƒ³å¾©å·åŒ–</button>
            <div id="tokenResult" class="result" style="display: none;"></div>
        </div>

        <!-- 3. QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã¨è¡¨ç¤º -->
        <div class="section">
            <h2>3. QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã¨è¡¨ç¤º</h2>
            <div class="grid">
                <div>
                    <h3>å¾“æ¥ã®URL</h3>
                    <div class="qr-display">
                        <canvas id="normalQR" width="200" height="200"></canvas>
                    </div>
                    <div id="normalUrl" class="result" style="display: none;"></div>
                </div>
                <div>
                    <h3>æš—å·åŒ–ãƒˆãƒ¼ã‚¯ãƒ³URL</h3>
                    <div class="qr-display">
                        <canvas id="encryptedQR" width="200" height="200"></canvas>
                    </div>
                    <div id="encryptedUrl" class="result" style="display: none;"></div>
                </div>
            </div>
            <button onclick="generateQRCodes()">ğŸ“± QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</button>
        </div>

        <!-- 4. ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ -->
        <div class="section">
            <h2>4. ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h2>
            <div id="systemStatus" class="status">ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...</div>
            <button onclick="checkSystemStatus()" class="secondary">ğŸ” çŠ¶æ…‹ç¢ºèª</button>
            <button onclick="clearTestData()" class="warning">ğŸ—‘ï¸ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
        </div>
    </div>

    <!-- QRã‚³ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyDh1B7fDVs5FdFzE2nnGQKQNzFGvGkYMQE",
            authDomain: "qrscan2-99ffd.firebaseapp.com",
            projectId: "qrscan2-99ffd",
            storageBucket: "qrscan2-99ffd.appspot.com",
            messagingSenderId: "1089215781575",
            appId: "1:1089215781575:web:35cab4f6dc9a9b70dda70e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentToken = null;
        let currentKey = null;

        // æš—å·åŒ–ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆcrypto-utils.jsã®å†…å®¹ã‚’ç›´æ¥å«ã‚ã‚‹ï¼‰
        function generateRandomKey(length = 32) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function xorEncrypt(text, key) {
            let result = '';
            for (let i = 0; i < text.length; i++) {
                result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
            }
            return result;
        }

        function xorDecrypt(encrypted, key) {
            return xorEncrypt(encrypted, key); // XORã¯å¯é€†çš„
        }

        function encodeBase64URL(str) {
            return btoa(unescape(encodeURIComponent(str)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        function decodeBase64URL(str) {
            str = (str + '===').slice(0, str.length + (str.length % 4));
            str = str.replace(/-/g, '+').replace(/_/g, '/');
            return decodeURIComponent(escape(atob(str)));
        }

        function generateQRToken(adminId, eventId, key) {
            // å›ºå®šãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãªã—ï¼‰
            const data = `${adminId}|${eventId}`;
            const encrypted = xorEncrypt(data, key);
            return encodeBase64URL(encrypted);
        }

        function decodeQRToken(token, key) {
            try {
                const decoded = decodeBase64URL(token);
                const decrypted = xorDecrypt(decoded, key);
                const parts = decrypted.split('|');

                if (parts.length < 2) {
                    throw new Error('Invalid token format');
                }

                const [adminId, eventId] = parts;
                return {
                    adminId,
                    eventId,
                    isFixed: true
                };
            } catch (error) {
                throw new Error('ãƒˆãƒ¼ã‚¯ãƒ³ã®å¾©å·åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function isTokenValid(decryptedData) {
            // å›ºå®šãƒˆãƒ¼ã‚¯ãƒ³ã®å ´åˆã€å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚Œã°æœ‰åŠ¹
            return decryptedData && decryptedData.adminId && decryptedData.eventId;
        }

        // ç®¡ç†é–¢æ•°
        window.generateEncryptionKey = async function () {
            const adminId = document.getElementById('adminId').value;
            const result = document.getElementById('adminResult');

            try {
                const settingsRef = doc(db, 'admin_settings', adminId);
                const settingsDoc = await getDoc(settingsRef);

                let encryptionKey;
                if (settingsDoc.exists() && settingsDoc.data().qrEncryptionKey) {
                    encryptionKey = settingsDoc.data().qrEncryptionKey;
                    result.innerHTML = `æ—¢å­˜ã®ã‚­ãƒ¼ã‚’å–å¾—ã—ã¾ã—ãŸ:<br>Admin ID: ${adminId}<br>Encryption Key: ${encryptionKey}`;
                } else {
                    encryptionKey = generateRandomKey();
                    await setDoc(settingsRef, {
                        qrEncryptionKey: encryptionKey,
                        createdAt: new Date(),
                        updatedAt: new Date()
                    }, { merge: true });
                    result.innerHTML = `æ–°ã—ã„ã‚­ãƒ¼ã‚’ç”Ÿæˆã—ã¾ã—ãŸ:<br>Admin ID: ${adminId}<br>Encryption Key: ${encryptionKey}`;
                }

                currentKey = encryptionKey;
                result.style.display = 'block';
                updateSystemStatus('æˆåŠŸ', `ç®¡ç†è€… ${adminId} ã®ã‚­ãƒ¼ã‚’æº–å‚™ã—ã¾ã—ãŸ`);
            } catch (error) {
                result.innerHTML = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                result.style.display = 'block';
                updateSystemStatus('ã‚¨ãƒ©ãƒ¼', error.message);
            }
        };

        window.checkAdminSettings = async function () {
            const adminId = document.getElementById('adminId').value;
            const result = document.getElementById('adminResult');

            try {
                const settingsRef = doc(db, 'admin_settings', adminId);
                const settingsDoc = await getDoc(settingsRef);

                if (settingsDoc.exists()) {
                    const data = settingsDoc.data();
                    result.innerHTML = `ç®¡ç†è€…è¨­å®š:<br>${JSON.stringify(data, null, 2)}`;
                } else {
                    result.innerHTML = `ç®¡ç†è€… ${adminId} ã®è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`;
                }

                result.style.display = 'block';
            } catch (error) {
                result.innerHTML = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                result.style.display = 'block';
            }
        };

        window.generateTestToken = function () {
            const adminId = document.getElementById('adminId').value;
            const eventId = document.getElementById('eventId').value;
            const result = document.getElementById('tokenResult');

            if (!currentKey) {
                result.innerHTML = 'å…ˆã«æš—å·åŒ–ã‚­ãƒ¼ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„';
                result.style.display = 'block';
                return;
            }

            try {
                currentToken = generateQRToken(adminId, eventId, currentKey);
                result.innerHTML = `å›ºå®šãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆå®Œäº†:<br>${currentToken}<br><br>è©³ç´°:<br>Admin ID: ${adminId}<br>Event ID: ${eventId}<br>ãƒˆãƒ¼ã‚¯ãƒ³ã‚¿ã‚¤ãƒ—: å›ºå®š<br>ç”Ÿæˆæ™‚åˆ»: ${new Date().toLocaleString()}`;
                result.style.display = 'block';
                updateSystemStatus('æˆåŠŸ', 'å›ºå®šãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã¾ã—ãŸ');
            } catch (error) {
                result.innerHTML = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                result.style.display = 'block';
            }
        };

        window.decryptTestToken = function () {
            const result = document.getElementById('tokenResult');

            if (!currentToken || !currentKey) {
                result.innerHTML = 'å…ˆã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„';
                result.style.display = 'block';
                return;
            }

            try {
                const decrypted = decodeQRToken(currentToken, currentKey);
                const isValid = isTokenValid(decrypted);

                result.innerHTML = `å¾©å·åŒ–çµæœ:<br>Admin ID: ${decrypted.adminId}<br>Event ID: ${decrypted.eventId}<br>ãƒˆãƒ¼ã‚¯ãƒ³ã‚¿ã‚¤ãƒ—: ${decrypted.isFixed ? 'å›ºå®š' : 'å‹•çš„'}<br>æœ‰åŠ¹æ€§: ${isValid ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}<br>å¾©å·åŒ–æ™‚åˆ»: ${new Date().toLocaleString()}`;
                result.style.display = 'block';
                updateSystemStatus('æˆåŠŸ', 'å›ºå®šãƒˆãƒ¼ã‚¯ãƒ³ã‚’å¾©å·åŒ–ã—ã¾ã—ãŸ');
            } catch (error) {
                result.innerHTML = `å¾©å·åŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                result.style.display = 'block';
            }
        };

        window.generateQRCodes = function () {
            const adminId = document.getElementById('adminId').value;
            const eventId = document.getElementById('eventId').value;
            const docId = document.getElementById('testDocId').value;
            const baseUrl = window.location.origin;

            // å¾“æ¥ã®URL
            const normalUrl = `${baseUrl}/login.html?admin_id=${adminId}&event_id=${eventId}&uid=${docId}`;
            document.getElementById('normalUrl').innerHTML = normalUrl;
            document.getElementById('normalUrl').style.display = 'block';

            // æš—å·åŒ–ãƒˆãƒ¼ã‚¯ãƒ³URL
            if (currentToken) {
                const encryptedUrl = `${baseUrl}/users.html?token=${currentToken}&id=${docId}`;
                document.getElementById('encryptedUrl').innerHTML = encryptedUrl;
                document.getElementById('encryptedUrl').style.display = 'block';

                // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
                new QRious({
                    element: document.getElementById('normalQR'),
                    value: normalUrl,
                    size: 200,
                    background: 'white',
                    foreground: 'black'
                });

                new QRious({
                    element: document.getElementById('encryptedQR'),
                    value: encryptedUrl,
                    size: 200,
                    background: 'white',
                    foreground: 'black'
                });

                updateSystemStatus('æˆåŠŸ', 'QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã—ãŸ');
            } else {
                document.getElementById('encryptedUrl').innerHTML = 'ãƒˆãƒ¼ã‚¯ãƒ³ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“';
                document.getElementById('encryptedUrl').style.display = 'block';
            }
        };

        window.checkSystemStatus = function () {
            const adminId = document.getElementById('adminId').value;
            const eventId = document.getElementById('eventId').value;

            let status = 'âœ… ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸\n';
            status += `ğŸ”‘ æš—å·åŒ–ã‚­ãƒ¼: ${currentKey ? 'è¨­å®šæ¸ˆã¿' : 'æœªè¨­å®š'}\n`;
            status += `ğŸ¯ ãƒˆãƒ¼ã‚¯ãƒ³: ${currentToken ? 'ç”Ÿæˆæ¸ˆã¿' : 'æœªç”Ÿæˆ'}\n`;
            status += `ğŸ‘¤ ç®¡ç†è€…ID: ${adminId}\n`;
            status += `ğŸ“… ã‚¤ãƒ™ãƒ³ãƒˆID: ${eventId}\n`;
            status += `ğŸ•’ æœ€çµ‚æ›´æ–°: ${new Date().toLocaleString()}`;

            updateSystemStatus('æƒ…å ±', status);
        };

        window.clearTestData = function () {
            if (confirm('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                currentToken = null;
                currentKey = null;
                document.getElementById('tokenResult').style.display = 'none';
                document.getElementById('adminResult').style.display = 'none';
                document.getElementById('normalUrl').style.display = 'none';
                document.getElementById('encryptedUrl').style.display = 'none';
                updateSystemStatus('æƒ…å ±', 'ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            }
        };

        function updateSystemStatus(type, message) {
            const statusEl = document.getElementById('systemStatus');
            statusEl.className = `status ${type === 'ã‚¨ãƒ©ãƒ¼' ? 'error' : 'success'}`;
            statusEl.textContent = `${type}: ${message}`;
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function () {
            updateSystemStatus('æƒ…å ±', 'ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ');
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QRãƒ­ã‚°ã‚¤ãƒ³ - QRã‚¹ã‚­ãƒ£ãƒ³ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .login-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 40px;
        max-width: 500px;
        width: 100%;
        text-align: center;
      }

      .logo {
        font-size: 2.5em;
        color: #667eea;
        margin-bottom: 10px;
        font-weight: bold;
      }

      .subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 1.1em;
      }

      .loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      .status-message {
        color: #666;
        font-size: 1.1em;
        margin-top: 20px;
      }

      .error-message {
        background: #ffe6e6;
        color: #d63031;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        border: 1px solid #fdbcbc;
      }

      .success-message {
        background: #e8f5e8;
        color: #00b894;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        border: 1px solid #b8e6b8;
      }

      .debug-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        font-size: 0.9em;
        color: #6c757d;
        text-align: left;
      }

      .debug-info h4 {
        color: #495057;
        margin-bottom: 10px;
      }

      .debug-info ul {
        list-style-type: none;
        padding-left: 0;
      }

      .debug-info li {
        padding: 2px 0;
        word-break: break-all;
      }

      .btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-size: 1em;
        cursor: pointer;
        margin-top: 20px;
        transition: background 0.3s;
      }

      .btn:hover {
        background: #5a67d8;
      }
    </style>
  </head>

  <body>
    <div class="login-container">
      <div class="logo">ğŸ” QRãƒ­ã‚°ã‚¤ãƒ³</div>
      <div class="subtitle">QRã‚³ãƒ¼ãƒ‰ã‚¢ã‚¯ã‚»ã‚¹èªè¨¼ä¸­...</div>

      <div id="loadingArea" class="loading">
        <div class="spinner"></div>
        <div class="status-message" id="statusMessage">
          URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç¢ºèªä¸­...
        </div>
      </div>

      <div id="messageArea"></div>
      <div id="debugArea"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      // Firebase imports
      import {
        initializeApp,
        getApps,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // Firebaseè¨­å®š
      const firebaseConfig = {
        apiKey: "AIzaSyCWFL91baSHkjkvU_k-yTUv6QS191YTFlg",
        authDomain: "qrscan2-99ffd.firebaseapp.com",
        projectId: "qrscan2-99ffd",
        storageBucket: "qrscan2-99ffd.firebasestorage.app",
        messagingSenderId: "1089215781575",
        appId: "1:1089215781575:web:bf9d05f6930b7123813ce2",
        measurementId: "G-QZZWT3HW0W",
      };

      // FirebaseåˆæœŸåŒ–
      const app = getApps().length
        ? getApps()[0]
        : initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // DOMè¦ç´ 
      const loadingArea = document.getElementById("loadingArea");
      const messageArea = document.getElementById("messageArea");
      const debugArea = document.getElementById("debugArea");
      const statusMessage = document.getElementById("statusMessage");

      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
      const urlParams = new URLSearchParams(window.location.search);
      const adminId = urlParams.get("admin_id");
      const eventId = urlParams.get("event_id");
      const userId = urlParams.get("user_id"); // user_idãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å¤‰æ›´

      console.log("=== QRãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ ===");
      console.log("URL:", window.location.href);
      console.log("URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:", { adminId, eventId, userId });

      // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
      function showDebugInfo(info) {
        debugArea.innerHTML = `
                <div class="debug-info">
                    <h4>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</h4>
                    <ul>
                        <li><strong>admin_id:</strong> ${
                          info.adminId || "æœªè¨­å®š"
                        }</li>
                        <li><strong>event_id:</strong> ${
                          info.eventId || "æœªè¨­å®š"
                        }</li>
                        <li><strong>user_id:</strong> ${
                          info.userId || "æœªè¨­å®š"
                        }</li>
                        <li><strong>å–å¾—ã—ãŸrole:</strong> ${
                          info.role || "æœªè¨­å®š"
                        }</li>
                        <li><strong>ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆ:</strong> ${
                          info.redirectUrl || "æœªè¨­å®š"
                        }</li>
                    </ul>
                </div>
            `;
      }

      // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
      function showError(message) {
        loadingArea.style.display = "none";
        messageArea.innerHTML = `<div class="error-message">${message}</div>`;
      }

      // æˆåŠŸè¡¨ç¤º
      function showSuccess(message) {
        loadingArea.style.display = "none";
        messageArea.innerHTML = `<div class="success-message">${message}</div>`;
      }

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
      function updateStatus(message) {
        statusMessage.textContent = message;
      }

      // roleã«åŸºã¥ããƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆæ±ºå®š
      function getRedirectUrl(role, adminId, eventId) {
        const baseParams =
          adminId && eventId ? `?admin_id=${adminId}&event_id=${eventId}` : "";

        switch (role) {
          case "admin":
            return `admin.html${baseParams}`;
          case "staff":
            return `staff.html${baseParams}`;
          case "maker":
            return `maker.html${baseParams}`;
          case "uketuke":
            return `uketuke.html${baseParams}`;
          case "user":
            return `user.html${baseParams}`;
          default:
            return `superuser.html${baseParams}`;
        }
      }

      // admin_settingsã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
      async function getUserInfoFromAdminSettings(uid) {
        try {
          updateStatus("admin_settingsã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ä¸­...");
          const adminDoc = await getDoc(doc(db, "admin_settings", uid));
          if (adminDoc.exists()) {
            const data = adminDoc.data();
            console.log("admin_settingsã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:", data);
            return data;
          }
          console.warn("admin_settingsã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", uid);
          return null;
        } catch (error) {
          console.error("admin_settingså–å¾—ã‚¨ãƒ©ãƒ¼:", error);
          return null;
        }
      }

      // ç‰¹å®šUIDã®roleãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
      function getTestUserRole(uid) {
        const testUsers = {
          kF5eX2FYyBUpxeNxfo6Jvlya38P2: "uketuke",
          // å¿…è¦ã«å¿œã˜ã¦ä»–ã®ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ 
        };
        return testUsers[uid] || null;
      }

      // Firebase Authã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ï¼ˆåŒ¿åèªè¨¼ã¾ãŸã¯æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ©ç”¨ï¼‰
      async function authenticateUser() {
        try {
          updateStatus("Firebaseèªè¨¼ã‚’ç¢ºèªä¸­...");

          // æ—¢ã«èªè¨¼æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
          if (auth.currentUser) {
            console.log("æ—¢ã«Firebaseèªè¨¼æ¸ˆã¿:", auth.currentUser.uid);
            return auth.currentUser;
          }

          // Firebaseèªè¨¼çŠ¶æ…‹ã‚’å¾…æ©Ÿ
          return new Promise((resolve, reject) => {
            const unsubscribe = onAuthStateChanged(auth, (user) => {
              unsubscribe();
              if (user) {
                console.log("Firebaseèªè¨¼æˆåŠŸ:", user.uid);
                resolve(user);
              } else {
                console.warn("Firebaseèªè¨¼ãªã—ã€åŒ¿åèªè¨¼ã‚’è©¦è¡Œ");
                // åŒ¿åèªè¨¼ã‚„æ—¢å­˜ã®ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’ã“ã“ã§å®Ÿè¡Œ
                reject(new Error("Firebaseèªè¨¼ãŒå¿…è¦ã§ã™"));
              }
            });

            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†
            setTimeout(() => {
              unsubscribe();
              reject(new Error("èªè¨¼ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ"));
            }, 10000);
          });
        } catch (error) {
          console.error("Firebaseèªè¨¼ã‚¨ãƒ©ãƒ¼:", error);
          throw error;
        }
      }

      // ãƒ¡ã‚¤ãƒ³å‡¦ç†
      async function main() {
        try {
          // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¤œè¨¼
          if (!adminId || !eventId || !userId) {
            throw new Error(
              "å¿…è¦ãªURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚QRã‚³ãƒ¼ãƒ‰ã‚’å†åº¦ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚"
            );
          }

          showDebugInfo({ adminId, eventId, userId });

          // Firebaseèªè¨¼
          updateStatus("Firebaseèªè¨¼ä¸­...");
          const firebaseUser = await authenticateUser();

          // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
          updateStatus("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ä¸­...");
          let userRole = null;

          // 1. admin_settingsã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ
          const adminData = await getUserInfoFromAdminSettings(userId);
          if (adminData && adminData.role) {
            userRole = adminData.role;
            console.log("admin_settingsã‹ã‚‰roleå–å¾—æˆåŠŸ:", userRole);
          } else {
            // 2. ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ç¢ºèª
            userRole = getTestUserRole(userId);
            if (userRole) {
              console.log("ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°ã‹ã‚‰roleå–å¾—:", userRole);
            }
          }

          if (!userRole) {
            throw new Error(
              `user_id: ${userId} ã«å¯¾å¿œã™ã‚‹roleãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚`
            );
          }

          // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆæ±ºå®š
          const redirectUrl = getRedirectUrl(userRole, adminId, eventId);

          showDebugInfo({
            adminId,
            eventId,
            userId,
            role: userRole,
            redirectUrl,
          });

          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
          showSuccess(
            `èªè¨¼æˆåŠŸï¼${userRole}ã¨ã—ã¦${redirectUrl}ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™...`
          );

          // 2ç§’å¾Œã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
          setTimeout(() => {
            console.log(`ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå®Ÿè¡Œ: ${redirectUrl}`);
            window.location.href = redirectUrl;
          }, 2000);
        } catch (error) {
          console.error("QRãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:", error);
          showError(error.message);

          showDebugInfo({
            adminId,
            eventId,
            userId,
            role: "ã‚¨ãƒ©ãƒ¼",
            redirectUrl: "ãªã—",
          });

          // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯æ‰‹å‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          messageArea.innerHTML += `
                    <button class="btn" onclick="window.location.href='superuser.html'">
                        ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
                    </button>
                `;
        }
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ - login.jsã«å§”è­²ã™ã‚‹ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
      // document.addEventListener('DOMContentLoaded', main);
    </script>

    <!-- æ–°ã—ã„QRã‚³ãƒ¼ãƒ‰èªè¨¼å‡¦ç† -->
    <script type="module" src="js/login.js"></script>
  </body>
</html>

<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QRログイン - QRスキャンシステム</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .login-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 40px;
        max-width: 500px;
        width: 100%;
        text-align: center;
      }

      .logo {
        font-size: 2.5em;
        color: #667eea;
        margin-bottom: 10px;
        font-weight: bold;
      }

      .subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 1.1em;
      }

      .loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      .status-message {
        color: #666;
        font-size: 1.1em;
        margin-top: 20px;
      }

      .error-message {
        background: #ffe6e6;
        color: #d63031;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        border: 1px solid #fdbcbc;
      }

      .success-message {
        background: #e8f5e8;
        color: #00b894;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        border: 1px solid #b8e6b8;
      }

      .debug-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        font-size: 0.9em;
        color: #6c757d;
        text-align: left;
      }

      .debug-info h4 {
        color: #495057;
        margin-bottom: 10px;
      }

      .debug-info ul {
        list-style-type: none;
        padding-left: 0;
      }

      .debug-info li {
        padding: 2px 0;
        word-break: break-all;
      }

      .btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-size: 1em;
        cursor: pointer;
        margin-top: 20px;
        transition: background 0.3s;
      }

      .btn:hover {
        background: #5a67d8;
      }
    </style>
  </head>

  <body>
    <div class="login-container">
      <div class="logo">🔐 QRログイン</div>
      <div class="subtitle">QRコードアクセス認証中...</div>

      <div id="loadingArea" class="loading">
        <div class="spinner"></div>
        <div class="status-message" id="statusMessage">
          URLパラメータを確認中...
        </div>
      </div>

      <div id="messageArea"></div>
      <div id="debugArea"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      // Firebase imports
      import {
        initializeApp,
        getApps,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // Firebase設定
      const firebaseConfig = {
        apiKey: "AIzaSyCWFL91baSHkjkvU_k-yTUv6QS191YTFlg",
        authDomain: "qrscan2-99ffd.firebaseapp.com",
        projectId: "qrscan2-99ffd",
        storageBucket: "qrscan2-99ffd.firebasestorage.app",
        messagingSenderId: "1089215781575",
        appId: "1:1089215781575:web:bf9d05f6930b7123813ce2",
        measurementId: "G-QZZWT3HW0W",
      };

      // Firebase初期化
      const app = getApps().length
        ? getApps()[0]
        : initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // DOM要素
      const loadingArea = document.getElementById("loadingArea");
      const messageArea = document.getElementById("messageArea");
      const debugArea = document.getElementById("debugArea");
      const statusMessage = document.getElementById("statusMessage");

      // URLパラメータ取得
      const urlParams = new URLSearchParams(window.location.search);
      const adminId = urlParams.get("admin_id");
      const eventId = urlParams.get("event_id");
      const userId = urlParams.get("user_id"); // user_idパラメータに変更

      console.log("=== QRログインページ読み込み ===");
      console.log("URL:", window.location.href);
      console.log("URLパラメータ:", { adminId, eventId, userId });

      // デバッグ情報表示
      function showDebugInfo(info) {
        debugArea.innerHTML = `
                <div class="debug-info">
                    <h4>デバッグ情報:</h4>
                    <ul>
                        <li><strong>admin_id:</strong> ${
                          info.adminId || "未設定"
                        }</li>
                        <li><strong>event_id:</strong> ${
                          info.eventId || "未設定"
                        }</li>
                        <li><strong>user_id:</strong> ${
                          info.userId || "未設定"
                        }</li>
                        <li><strong>取得したrole:</strong> ${
                          info.role || "未設定"
                        }</li>
                        <li><strong>リダイレクト先:</strong> ${
                          info.redirectUrl || "未設定"
                        }</li>
                    </ul>
                </div>
            `;
      }

      // エラー表示
      function showError(message) {
        loadingArea.style.display = "none";
        messageArea.innerHTML = `<div class="error-message">${message}</div>`;
      }

      // 成功表示
      function showSuccess(message) {
        loadingArea.style.display = "none";
        messageArea.innerHTML = `<div class="success-message">${message}</div>`;
      }

      // ステータス更新
      function updateStatus(message) {
        statusMessage.textContent = message;
      }

      // roleに基づくリダイレクト先決定
      function getRedirectUrl(role, adminId, eventId) {
        const baseParams =
          adminId && eventId ? `?admin_id=${adminId}&event_id=${eventId}` : "";

        switch (role) {
          case "admin":
            return `admin.html${baseParams}`;
          case "staff":
            return `staff.html${baseParams}`;
          case "maker":
            return `maker.html${baseParams}`;
          case "uketuke":
            return `uketuke.html${baseParams}`;
          case "user":
            return `user.html${baseParams}`;
          default:
            return `superuser.html${baseParams}`;
        }
      }

      // admin_settingsからユーザー情報取得
      async function getUserInfoFromAdminSettings(uid) {
        try {
          updateStatus("admin_settingsからユーザー情報を取得中...");
          const adminDoc = await getDoc(doc(db, "admin_settings", uid));
          if (adminDoc.exists()) {
            const data = adminDoc.data();
            console.log("admin_settingsからデータ取得成功:", data);
            return data;
          }
          console.warn("admin_settingsにドキュメントが見つかりません:", uid);
          return null;
        } catch (error) {
          console.error("admin_settings取得エラー:", error);
          return null;
        }
      }

      // 特定UIDのroleマッピング（テスト用）
      function getTestUserRole(uid) {
        const testUsers = {
          kF5eX2FYyBUpxeNxfo6Jvlya38P2: "uketuke",
          // 必要に応じて他のテストユーザーを追加
        };
        return testUsers[uid] || null;
      }

      // Firebase Authでサインイン（匿名認証または既存セッション利用）
      async function authenticateUser() {
        try {
          updateStatus("Firebase認証を確認中...");

          // 既に認証済みかチェック
          if (auth.currentUser) {
            console.log("既にFirebase認証済み:", auth.currentUser.uid);
            return auth.currentUser;
          }

          // Firebase認証状態を待機
          return new Promise((resolve, reject) => {
            const unsubscribe = onAuthStateChanged(auth, (user) => {
              unsubscribe();
              if (user) {
                console.log("Firebase認証成功:", user.uid);
                resolve(user);
              } else {
                console.warn("Firebase認証なし、匿名認証を試行");
                // 匿名認証や既存のログイン処理をここで実行
                reject(new Error("Firebase認証が必要です"));
              }
            });

            // タイムアウト処理
            setTimeout(() => {
              unsubscribe();
              reject(new Error("認証タイムアウト"));
            }, 10000);
          });
        } catch (error) {
          console.error("Firebase認証エラー:", error);
          throw error;
        }
      }

      // メイン処理
      async function main() {
        try {
          // URLパラメータ検証
          if (!adminId || !eventId || !userId) {
            throw new Error(
              "必要なURLパラメータが不足しています。QRコードを再度スキャンしてください。"
            );
          }

          showDebugInfo({ adminId, eventId, userId });

          // Firebase認証
          updateStatus("Firebase認証中...");
          const firebaseUser = await authenticateUser();

          // ユーザー情報取得
          updateStatus("ユーザー情報を取得中...");
          let userRole = null;

          // 1. admin_settingsから取得を試行
          const adminData = await getUserInfoFromAdminSettings(userId);
          if (adminData && adminData.role) {
            userRole = adminData.role;
            console.log("admin_settingsからrole取得成功:", userRole);
          } else {
            // 2. テストユーザーマッピングを確認
            userRole = getTestUserRole(userId);
            if (userRole) {
              console.log("テストユーザーマッピングからrole取得:", userRole);
            }
          }

          if (!userRole) {
            throw new Error(
              `user_id: ${userId} に対応するroleが見つかりません。管理者にお問い合わせください。`
            );
          }

          // リダイレクト先決定
          const redirectUrl = getRedirectUrl(userRole, adminId, eventId);

          showDebugInfo({
            adminId,
            eventId,
            userId,
            role: userRole,
            redirectUrl,
          });

          // 成功メッセージとリダイレクト
          showSuccess(
            `認証成功！${userRole}として${redirectUrl}にリダイレクトします...`
          );

          // 2秒後にリダイレクト
          setTimeout(() => {
            console.log(`リダイレクト実行: ${redirectUrl}`);
            window.location.href = redirectUrl;
          }, 2000);
        } catch (error) {
          console.error("QRログインエラー:", error);
          showError(error.message);

          showDebugInfo({
            adminId,
            eventId,
            userId,
            role: "エラー",
            redirectUrl: "なし",
          });

          // エラーの場合は手動リダイレクトボタンを表示
          messageArea.innerHTML += `
                    <button class="btn" onclick="window.location.href='superuser.html'">
                        ログイン画面に戻る
                    </button>
                `;
        }
      }

      // ページ読み込み時に実行 - login.jsに委譲するためコメントアウト
      // document.addEventListener('DOMContentLoaded', main);
    </script>

    <!-- 新しいQRコード認証処理 -->
    <script type="module" src="js/login.js"></script>
  </body>
</html>

<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRコードアクセス - 来場者認証</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .logo {
            font-size: 48px;
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            margin: 0 0 10px 0;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .status {
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
        }

        .status.loading {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
        }

        .user-info {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .user-info h3 {
            margin: 0 0 15px 0;
            color: #333;
        }

        .user-info p {
            margin: 8px 0;
            color: #666;
        }

        .user-info strong {
            color: #333;
        }

        .actions {
            margin-top: 30px;
        }

        .btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #3367d6;
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            background: #545b62;
        }

        .footer {
            margin-top: 30px;
            font-size: 12px;
            color: #999;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            text-align: left;
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="logo">🎯</div>
        <h1>来場者認証</h1>
        <p class="subtitle">QRコードによるアクセスを確認しています...</p>

        <div id="status" class="status loading">
            認証情報を確認中...
        </div>

        <div id="userInfo" class="user-info" style="display: none;">
            <!-- ユーザー情報がここに表示される -->
        </div>

        <div id="actions" class="actions" style="display: none;">
            <button class="btn" onclick="proceedToLogin()">ログインに進む</button>
            <button class="btn secondary" onclick="showDebugInfo()">詳細情報</button>
        </div>

        <div id="debugInfo" class="debug-info">
            <!-- デバッグ情報がここに表示される -->
        </div>

        <div class="footer">
            QR Scan System - Secure Access
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { decodeQRToken, isTokenValid } from './js/crypto-utils.js';

        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyDh1B7fDVs5FdFzE2nnGQKQNzFGvGkYMQE",
            authDomain: "qrscan2-99ffd.firebaseapp.com",
            projectId: "qrscan2-99ffd",
            storageBucket: "qrscan2-99ffd.appspot.com",
            messagingSenderId: "1089215781575",
            appId: "1:1089215781575:web:35cab4f6dc9a9b70dda70e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // グローバル変数
        let verifiedData = null;

        // URLパラメータを解析
        function parseURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                token: urlParams.get('token'),
                id: urlParams.get('id')
            };
        }

        // 管理者リストから暗号化キーを取得してトークンを復号化
        async function findAdminAndDecryptToken(token) {
            try {
                // admin_settingsコレクション内の全ドキュメントを確認
                // 実際のプロダクションでは、より効率的な方法を検討する必要があります

                // 既知の管理者IDリストを試行（改善版）
                const knownAdmins = ['ADMIN001', 'TEST_ADMIN', 'DEFAULT']; // 実際の管理者IDに応じて調整

                for (const adminId of knownAdmins) {
                    try {
                        const encryptionKey = await getEncryptionKey(adminId);
                        const decryptedData = decodeQRToken(token, encryptionKey);

                        if (decryptedData && isTokenValid(decryptedData)) {
                            return {
                                adminId,
                                eventId: decryptedData.eventId,
                                originalAdminId: decryptedData.adminId,
                                isFixed: true // 固定トークンフラグ
                            };
                        }
                    } catch (error) {
                        // このadmin_idでは復号化できなかった、次を試行
                        continue;
                    }
                }

                throw new Error('有効な暗号化キーが見つかりませんでした');
            } catch (error) {
                console.error('トークン復号化エラー:', error);
                throw error;
            }
        }

        // ユーザーデータを取得
        async function getUserData(adminId, eventId, docId) {
            try {
                const userPath = `admin_collections/${adminId}/${eventId}_users`;
                const userRef = doc(db, userPath, docId);
                const userDoc = await getDoc(userRef);

                if (!userDoc.exists()) {
                    throw new Error('ユーザーデータが見つかりません');
                }

                return userDoc.data();
            } catch (error) {
                console.error('ユーザーデータ取得エラー:', error);
                throw error;
            }
        }

        // 認証処理
        async function authenticateUser() {
            const statusEl = document.getElementById('status');
            const userInfoEl = document.getElementById('userInfo');
            const actionsEl = document.getElementById('actions');
            const debugInfoEl = document.getElementById('debugInfo');

            try {
                // URLパラメータを取得
                const { token, id } = parseURL();

                if (!token || !id) {
                    throw new Error('必要なパラメータが不足しています');
                }

                // デバッグ情報を更新
                debugInfoEl.innerHTML = `
                    <strong>Debug Information:</strong><br>
                    Token: ${token.substring(0, 20)}...<br>
                    Document ID: ${id}<br>
                    Timestamp: ${new Date().toISOString()}
                `;

                statusEl.textContent = 'トークンを復号化中...';

                // 管理者を特定してトークンを復号化
                const decryptedInfo = await findAdminAndDecryptToken(token);

                statusEl.textContent = 'ユーザーデータを取得中...';

                // ユーザーデータを取得
                const userData = await getUserData(decryptedInfo.adminId, decryptedInfo.eventId, id);

                // 認証成功
                verifiedData = {
                    adminId: decryptedInfo.adminId,
                    eventId: decryptedInfo.eventId,
                    docId: id,
                    userData: userData,
                    isFixed: decryptedInfo.isFixed || false
                };

                statusEl.className = 'status success';
                statusEl.innerHTML = '✅ 認証成功';

                // ユーザー情報を表示
                userInfoEl.innerHTML = `
                    <h3>認証されたユーザー情報</h3>
                    <p><strong>ユーザー名:</strong> ${userData.user_name || 'N/A'}</p>
                    <p><strong>会社名:</strong> ${userData.company_name || 'N/A'}</p>
                    <p><strong>役職:</strong> ${userData.user_role || 'N/A'}</p>
                    <p><strong>ユーザーID:</strong> ${userData.user_id || id}</p>
                    <p><strong>イベント:</strong> ${decryptedInfo.eventId}</p>
                `;
                userInfoEl.style.display = 'block';

                actionsEl.style.display = 'block';

                // デバッグ情報を更新
                debugInfoEl.innerHTML = `
                    <strong>Debug Information:</strong><br>
                    Token: ${token.substring(0, 20)}...<br>
                    Admin ID: ${decryptedInfo.adminId}<br>
                    Event ID: ${decryptedInfo.eventId}<br>
                    Document ID: ${id}<br>
                    Token Type: ${decryptedInfo.isFixed ? '固定トークン' : '動的トークン'}<br>
                    Access Time: ${new Date().toISOString()}
                `;

            } catch (error) {
                console.error('認証エラー:', error);
                statusEl.className = 'status error';
                statusEl.innerHTML = `
                    ❌ 認証に失敗しました<br>
                    <small>${error.message}</small><br>
                    <small>従来のログイン方式を使用してください</small>
                `;

                actionsEl.style.display = 'block';
                actionsEl.innerHTML = `
                    <a href="login.html" class="btn">通常ログインへ</a>
                    <button class="btn secondary" onclick="showDebugInfo()">詳細情報</button>
                `;
            }
        }

        // ログインページに進む
        window.proceedToLogin = function () {
            if (verifiedData) {
                const params = new URLSearchParams({
                    admin_id: verifiedData.adminId,
                    event_id: verifiedData.eventId,
                    uid: verifiedData.docId
                });
                window.location.href = `login.html?${params.toString()}`;
            } else {
                window.location.href = 'login.html';
            }
        };

        // デバッグ情報表示
        window.showDebugInfo = function () {
            const debugInfoEl = document.getElementById('debugInfo');
            debugInfoEl.style.display = debugInfoEl.style.display === 'none' ? 'block' : 'none';
        };

        // ページ読み込み時に認証開始
        document.addEventListener('DOMContentLoaded', authenticateUser);
    </script>
</body>

</html>
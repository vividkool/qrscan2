<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRã‚³ãƒ¼ãƒ‰ã‚¢ã‚¯ã‚»ã‚¹ - æ¥å ´è€…èªè¨¼</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .logo {
            font-size: 48px;
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            margin: 0 0 10px 0;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .status {
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
        }

        .status.loading {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
        }

        .user-info {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .user-info h3 {
            margin: 0 0 15px 0;
            color: #333;
        }

        .user-info p {
            margin: 8px 0;
            color: #666;
        }

        .user-info strong {
            color: #333;
        }

        .actions {
            margin-top: 30px;
        }

        .btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #3367d6;
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            background: #545b62;
        }

        .footer {
            margin-top: 30px;
            font-size: 12px;
            color: #999;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            text-align: left;
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="logo">ğŸ¯</div>
        <h1>æ¥å ´è€…èªè¨¼</h1>
        <p class="subtitle">QRã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™...</p>

        <div id="status" class="status loading">
            èªè¨¼æƒ…å ±ã‚’ç¢ºèªä¸­...
        </div>

        <div id="userInfo" class="user-info" style="display: none;">
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
        </div>

        <div id="actions" class="actions" style="display: none;">
            <button class="btn" onclick="proceedToLogin()">ãƒ­ã‚°ã‚¤ãƒ³ã«é€²ã‚€</button>
            <button class="btn secondary" onclick="showDebugInfo()">è©³ç´°æƒ…å ±</button>
        </div>

        <div id="debugInfo" class="debug-info">
            <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
        </div>

        <div class="footer">
            QR Scan System - Secure Access
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { decodeQRToken, isTokenValid } from './js/crypto-utils.js';

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyDh1B7fDVs5FdFzE2nnGQKQNzFGvGkYMQE",
            authDomain: "qrscan2-99ffd.firebaseapp.com",
            projectId: "qrscan2-99ffd",
            storageBucket: "qrscan2-99ffd.appspot.com",
            messagingSenderId: "1089215781575",
            appId: "1:1089215781575:web:35cab4f6dc9a9b70dda70e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let verifiedData = null;

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è§£æ
        function parseURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                token: urlParams.get('token'),
                id: urlParams.get('id')
            };
        }

        // ç®¡ç†è€…ãƒªã‚¹ãƒˆã‹ã‚‰æš—å·åŒ–ã‚­ãƒ¼ã‚’å–å¾—ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å¾©å·åŒ–
        async function findAdminAndDecryptToken(token) {
            try {
                // admin_settingsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…ã®å…¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèª
                // å®Ÿéš›ã®ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ã‚ˆã‚ŠåŠ¹ç‡çš„ãªæ–¹æ³•ã‚’æ¤œè¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

                // æ—¢çŸ¥ã®ç®¡ç†è€…IDãƒªã‚¹ãƒˆã‚’è©¦è¡Œï¼ˆæ”¹å–„ç‰ˆï¼‰
                const knownAdmins = ['ADMIN001', 'TEST_ADMIN', 'DEFAULT']; // å®Ÿéš›ã®ç®¡ç†è€…IDã«å¿œã˜ã¦èª¿æ•´

                for (const adminId of knownAdmins) {
                    try {
                        const encryptionKey = await getEncryptionKey(adminId);
                        const decryptedData = decodeQRToken(token, encryptionKey);

                        if (decryptedData && isTokenValid(decryptedData)) {
                            return {
                                adminId,
                                eventId: decryptedData.eventId,
                                originalAdminId: decryptedData.adminId,
                                isFixed: true // å›ºå®šãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ãƒ©ã‚°
                            };
                        }
                    } catch (error) {
                        // ã“ã®admin_idã§ã¯å¾©å·åŒ–ã§ããªã‹ã£ãŸã€æ¬¡ã‚’è©¦è¡Œ
                        continue;
                    }
                }

                throw new Error('æœ‰åŠ¹ãªæš—å·åŒ–ã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            } catch (error) {
                console.error('ãƒˆãƒ¼ã‚¯ãƒ³å¾©å·åŒ–ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        async function getUserData(adminId, eventId, docId) {
            try {
                const userPath = `admin_collections/${adminId}/${eventId}_users`;
                const userRef = doc(db, userPath, docId);
                const userDoc = await getDoc(userRef);

                if (!userDoc.exists()) {
                    throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

                return userDoc.data();
            } catch (error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }

        // èªè¨¼å‡¦ç†
        async function authenticateUser() {
            const statusEl = document.getElementById('status');
            const userInfoEl = document.getElementById('userInfo');
            const actionsEl = document.getElementById('actions');
            const debugInfoEl = document.getElementById('debugInfo');

            try {
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
                const { token, id } = parseURL();

                if (!token || !id) {
                    throw new Error('å¿…è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                }

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æ›´æ–°
                debugInfoEl.innerHTML = `
                    <strong>Debug Information:</strong><br>
                    Token: ${token.substring(0, 20)}...<br>
                    Document ID: ${id}<br>
                    Timestamp: ${new Date().toISOString()}
                `;

                statusEl.textContent = 'ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å¾©å·åŒ–ä¸­...';

                // ç®¡ç†è€…ã‚’ç‰¹å®šã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å¾©å·åŒ–
                const decryptedInfo = await findAdminAndDecryptToken(token);

                statusEl.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...';

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const userData = await getUserData(decryptedInfo.adminId, decryptedInfo.eventId, id);

                // èªè¨¼æˆåŠŸ
                verifiedData = {
                    adminId: decryptedInfo.adminId,
                    eventId: decryptedInfo.eventId,
                    docId: id,
                    userData: userData,
                    isFixed: decryptedInfo.isFixed || false
                };

                statusEl.className = 'status success';
                statusEl.innerHTML = 'âœ… èªè¨¼æˆåŠŸ';

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
                userInfoEl.innerHTML = `
                    <h3>èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h3>
                    <p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</strong> ${userData.user_name || 'N/A'}</p>
                    <p><strong>ä¼šç¤¾å:</strong> ${userData.company_name || 'N/A'}</p>
                    <p><strong>å½¹è·:</strong> ${userData.user_role || 'N/A'}</p>
                    <p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</strong> ${userData.user_id || id}</p>
                    <p><strong>ã‚¤ãƒ™ãƒ³ãƒˆ:</strong> ${decryptedInfo.eventId}</p>
                `;
                userInfoEl.style.display = 'block';

                actionsEl.style.display = 'block';

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æ›´æ–°
                debugInfoEl.innerHTML = `
                    <strong>Debug Information:</strong><br>
                    Token: ${token.substring(0, 20)}...<br>
                    Admin ID: ${decryptedInfo.adminId}<br>
                    Event ID: ${decryptedInfo.eventId}<br>
                    Document ID: ${id}<br>
                    Token Type: ${decryptedInfo.isFixed ? 'å›ºå®šãƒˆãƒ¼ã‚¯ãƒ³' : 'å‹•çš„ãƒˆãƒ¼ã‚¯ãƒ³'}<br>
                    Access Time: ${new Date().toISOString()}
                `;

            } catch (error) {
                console.error('èªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
                statusEl.className = 'status error';
                statusEl.innerHTML = `
                    âŒ èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ<br>
                    <small>${error.message}</small><br>
                    <small>å¾“æ¥ã®ãƒ­ã‚°ã‚¤ãƒ³æ–¹å¼ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„</small>
                `;

                actionsEl.style.display = 'block';
                actionsEl.innerHTML = `
                    <a href="login.html" class="btn">é€šå¸¸ãƒ­ã‚°ã‚¤ãƒ³ã¸</a>
                    <button class="btn secondary" onclick="showDebugInfo()">è©³ç´°æƒ…å ±</button>
                `;
            }
        }

        // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«é€²ã‚€
        window.proceedToLogin = function () {
            if (verifiedData) {
                const params = new URLSearchParams({
                    admin_id: verifiedData.adminId,
                    event_id: verifiedData.eventId,
                    uid: verifiedData.docId
                });
                window.location.href = `login.html?${params.toString()}`;
            } else {
                window.location.href = 'login.html';
            }
        };

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
        window.showDebugInfo = function () {
            const debugInfoEl = document.getElementById('debugInfo');
            debugInfoEl.style.display = debugInfoEl.style.display === 'none' ? 'block' : 'none';
        };

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«èªè¨¼é–‹å§‹
        document.addEventListener('DOMContentLoaded', authenticateUser);
    </script>
</body>

</html>
// Firebase Index Page Functions
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  doc,
  setDoc,
  deleteDoc,
  query,
  orderBy,
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import "./template-utils.js";

// Firebaseè¨­å®š
const firebaseConfig = {
  apiKey: "AIzaSyCWFL91baSHkjkvU_k-yTUv6QS191YTFlg",
  authDomain: "qrscan2-99ffd.firebaseapp.com",
  projectId: "qrscan2-99ffd",
  storageBucket: "qrscan2-99ffd.firebasestorage.app",
  messagingSenderId: "1089215781575",
  appId: "1:1089215781575:web:bf9d05f6930b7123813ce2",
  measurementId: "G-QZZWT3HW0W",
};

// FirebaseåˆæœŸåŒ–
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ç®¡ç†
let currentCollectionType = null;

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
function clearResults(elementId) {
  const element = document.getElementById(elementId);
  element.textContent = "";
  element.className = "result";
  element.style.display = "none";

  // Firestoreã®çµæœã‚’ã‚¯ãƒªã‚¢ã™ã‚‹å ´åˆã¯è¿½åŠ ãƒœã‚¿ãƒ³ã‚‚éè¡¨ç¤º
  if (elementId === "firestoreResult") {
    updateAddButton(null);
  }
}

// UUIDç”Ÿæˆé–¢æ•°
function generateUUID() {
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
    const r = (Math.random() * 16) | 0;
    const v = c == "x" ? r : (r & 0x3) | 0x8;
    return v.toString(16);
  });
}

// ç¾åœ¨ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«å¿œã˜ãŸè¿½åŠ ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
function updateAddButton(collectionType) {
  currentCollectionType = collectionType;
  const addButton = document.getElementById("addDataButton");

  if (collectionType) {
    addButton.style.display = "block";
    const buttonText =
      collectionType === "items" ? "â• ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ " : "â• ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ";
    addButton.innerHTML = buttonText;
  } else {
    addButton.style.display = "none";
  }
}

// ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«æ–°è¦ãƒ‡ãƒ¼ã‚¿è¿½åŠ 
function addToCurrentCollection() {
  if (currentCollectionType) {
    openAddDataModal(currentCollectionType);
  }
}

// itemsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§è¡¨ç¤º
async function getAllItems() {
  try {
    showLoading("firestoreResult");

    // item_noã§æ˜‡é †ã‚½ãƒ¼ãƒˆã®ã‚¯ã‚¨ãƒªã‚’ä½œæˆ
    const q = query(collection(db, "items"), orderBy("item_no", "asc"));
    const querySnapshot = await getDocs(q);

    if (querySnapshot.empty) {
      showResult("firestoreResult", "ã‚¢ã‚¤ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“", "error");
      return;
    }
    let html = "<table><thead><tr>";
    html +=
      "<th>item_no</th><th>category_name</th><th>company_name</th><th>item_name</th><th>maker_code</th><th>æ“ä½œ</th>";
    html += "</tr></thead><tbody>";
    querySnapshot.forEach((docSnap) => {
      const d = docSnap.data();
      const docId = docSnap.id;
      html += `<tr><td>${d.item_no || ""}</td><td>${
        d.category_name || ""
      }</td><td>${d.company_name || ""}</td><td>${d.item_name || ""}</td><td>${
        d.maker_code || ""
      }</td><td><button onclick="deleteDocument('items', '${docId}', '${
        d.item_no || "unknown"
      }')" class="delete-btn">ğŸ—‘ï¸ å‰Šé™¤</button></td></tr>`;
    });
    html += "</tbody></table>";
    showResult("firestoreResult", html, "success");
    document.getElementById("firestoreResult-collectionname").textContent =
      "itemsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³";
    document.getElementById(
      "firestoreResult-count"
    ).textContent = `${querySnapshot.size}ä»¶`;

    // è¿½åŠ ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
    updateAddButton("items");
  } catch (error) {
    showResult("firestoreResult", `å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
    updateAddButton(null);
  }
}

// usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§è¡¨ç¤º
async function getAllUsers() {
  try {
    showLoading("firestoreResult");
    const querySnapshot = await getDocs(
      collection(db, "users"),
      orderBy("user_id", "asc")
    );

    if (querySnapshot.empty) {
      showResult("firestoreResult", "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“", "error");
      return;
    }
    let html = "<table><thead><tr>";
    html +=
      "<th>user_id</th><th>company_name</th><th>user_name</th><th>email</th><th>phone</th><th>department</th><th>status</th><th>role</th><th>print_status</th><th>æ“ä½œ</th>";
    html += "</tr></thead><tbody>";
    querySnapshot.forEach((docSnap) => {
      const d = docSnap.data();
      const docId = docSnap.id;
      html += `<tr><td>${d.user_id || ""}</td><td>${
        d.company_name || ""
      }</td><td>${d.user_name || ""}</td><td>${d.email || ""}</td><td>${
        d.phone || ""
      }</td><td>${d.department || ""}</td><td>${d.status || ""}</td><td>${
        d.user_role || ""
      }</td><td>${
        d.print_status || ""
      }</td><td><button onclick="deleteDocument('users', '${docId}', '${
        d.user_id || "unknown"
      }')" class="delete-btn">ğŸ—‘ï¸ å‰Šé™¤</button></td></tr>`;
    });
    html += "</tbody></table>";
    showResult("firestoreResult", html, "success");
    document.getElementById("firestoreResult-collectionname").textContent =
      "usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³";
    document.getElementById(
      "firestoreResult-count"
    ).textContent = `${querySnapshot.size}ä»¶`;

    // è¿½åŠ ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
    updateAddButton("users");
  } catch (error) {
    showResult("firestoreResult", `å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
    updateAddButton(null);
  }
}

async function getAllScanItems() {
  try {
    showLoading("firestoreResult");
    const querySnapshot = await getDocs(
      collection(db, "scanItems"),
      orderBy("timestamp", "desc")
    );

    if (querySnapshot.empty) {
      showResult("firestoreResult", "ã‚¹ã‚­ãƒ£ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“", "error");
      return;
    }
    let html = "<table><thead><tr>";
    html +=
      "<th>content</th><th>timestamp</th><th>user_name</th><th>user_role</th><th>company_name</th><th>scannerMode</th><th>æ“ä½œ</th>";
    html += "</tr></thead><tbody>";
    querySnapshot.forEach((docSnap) => {
      const d = docSnap.data();
      const docId = docSnap.id;
      const timestamp = d.timestamp
        ? new Date(d.timestamp).toLocaleString("ja-JP")
        : "";
      html += `<tr><td>${d.content || ""}</td><td>${timestamp}</td><td>${
        d.user_name || ""
      }</td><td>${d.user_role || ""}</td><td>${d.company_name || ""}</td><td>${
        d.scannerMode || ""
      }</td><td><button onclick="deleteDocument('scanItems', '${docId}', '${
        d.content || "unknown"
      }')" class="delete-btn">ğŸ—‘ï¸ å‰Šé™¤</button></td></tr>`;
    });
    html += "</tbody></table>";
    showResult("firestoreResult", html, "success");
    document.getElementById("firestoreResult-collectionname").textContent =
      "ScanItemsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³";
    document.getElementById(
      "firestoreResult-count"
    ).textContent = `${querySnapshot.size}ä»¶`;
  } catch (error) {
    showResult("firestoreResult", `å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
  }
}

// Firestoreé–¢æ•°
async function addDocument() {
  const documentId = document.getElementById("documentId").value;
  const title = document.getElementById("dataTitle").value;
  const content = document.getElementById("dataContent").value;

  if (!title || !content) {
    showResult("firestoreResult", "ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "error");
    return;
  }

  try {
    showLoading("firestoreResult");

    const data = {
      title: title,
      content: content,
      timestamp: new Date().toISOString(),
      createdAt: new Date(),
    };

    let docRef;
    if (documentId) {
      docRef = doc(db, "qrscans", documentId);
      await setDoc(docRef, data);
    } else {
      docRef = await addDoc(collection(db, "qrscans"), data);
    }

    showResult(
      "firestoreResult",
      `ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ­£å¸¸ã«è¿½åŠ ã•ã‚Œã¾ã—ãŸ:\nID: ${
        docRef.id || documentId
      }\nã‚¿ã‚¤ãƒˆãƒ«: ${title}\nå†…å®¹: ${content}`,
      "success"
    );

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
    document.getElementById("documentId").value = "";
    document.getElementById("dataTitle").value = "";
    document.getElementById("dataContent").value = "";
  } catch (error) {
    showResult("firestoreResult", `ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
  }
}

// Cloud Functionsé–¢æ•°
async function callHelloWorld() {
  try {
    showLoading("functionResult");

    const response = await fetch(
      "https://asia-northeast1-qrscan2-99ffd.cloudfunctions.net/helloWorld"
    );
    const text = await response.text();

    showResult(
      "functionResult",
      `Function ãƒ¬ã‚¹ãƒãƒ³ã‚¹:\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status}\nå†…å®¹: ${text}`,
      "success"
    );
  } catch (error) {
    showResult("functionResult", `ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
  }
}

// ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‰Šé™¤é–¢æ•°
async function deleteDocument(collectionName, docId, displayName) {
  const modal = document.getElementById("addDataModal");
  const modalTitle = document.getElementById("modalTitle");
  const modalForm = document.getElementById("modalForm");

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
  modalTitle.textContent =
    collectionType === "items" ? "ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ " : "ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ";

  // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”Ÿæˆ
  modalForm.innerHTML = "";

  let fields;
  if (collectionType === "items") {
    fields = [
      { name: "item_no", label: "ã‚¢ã‚¤ãƒ†ãƒ ç•ªå·", type: "text", required: true },
      { name: "item_name", label: "ã‚¢ã‚¤ãƒ†ãƒ å", type: "text", required: true },
      {
        name: "category_name",
        label: "ã‚«ãƒ†ã‚´ãƒª",
        type: "text",
        required: false,
      },
      { name: "company_name", label: "ä¼šç¤¾å", type: "text", required: true },
      {
        name: "maker_code",
        label: "ãƒ¡ãƒ¼ã‚«ãƒ¼ã‚³ãƒ¼ãƒ‰",
        type: "text",
        required: false,
      },
    ];
  } else {
    fields = [
      { name: "user_id", label: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ID", type: "text", required: true },
      { name: "user_name", label: "ãƒ¦ãƒ¼ã‚¶ãƒ¼å", type: "text", required: true },
      {
        name: "email",
        label: "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹",
        type: "email",
        required: false,
      },
      { name: "phone", label: "é›»è©±ç•ªå·", type: "tel", required: false },
      { name: "department", label: "éƒ¨ç½²", type: "text", required: false },
      { name: "status", label: "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", type: "text", required: false },
      { name: "role", label: "å½¹å‰²", type: "text", required: false },
      {
        name: "print_status",
        label: "å°åˆ·ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹",
        type: "text",
        required: false,
      },
    ];
  }

  // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä½œæˆ
  fields.forEach((field) => {
    const div = document.createElement("div");
    div.className = "form-group";

    const label = document.createElement("label");
    label.textContent = field.label + (field.required ? " *" : "");
    label.setAttribute("for", field.name);

    const input = document.createElement("input");
    input.type = field.type;
    input.id = field.name;
    input.name = field.name;
    input.required = field.required;

    div.appendChild(label);
    div.appendChild(input);
    modalForm.appendChild(div);
  });

  // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ã‚’ä¿å­˜
  modal.dataset.collectionType = collectionType;

  // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  modal.style.display = "block";
}

function closeModal() {
  document.getElementById("addDataModal").style.display = "none";
}

async function submitAddData() {
  const modal = document.getElementById("addDataModal");
  const collectionType = modal.dataset.collectionType;
  const form = document.getElementById("modalForm");

  // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å–å¾—
  const formData = new FormData(form);
  const data = {};

  for (const [key, value] of formData.entries()) {
    // ä¾¡æ ¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ•°å€¤å¤‰æ›
    if (key === "price" && value) {
      data[key] = Number(value);
    } else {
      data[key] = value || "";
    }
  }

  try {
    showLoading("firestoreResult");

    // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³åã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDè¨­å®š
    const collectionName = collectionType;
    // UUIDã‚’ç”Ÿæˆã—ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã¨ã—ã¦ä½¿ç”¨
    const docId = generateUUID();

    // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
    const requiredId = collectionType === "items" ? data.item_no : data.user_id;
    if (!requiredId) {
      throw new Error(
        collectionType === "items"
          ? "ã‚¢ã‚¤ãƒ†ãƒ ç•ªå·ã¯å¿…é ˆã§ã™"
          : "ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯å¿…é ˆã§ã™"
      );
    }

    // Firestoreã«ä¿å­˜
    await setDoc(doc(db, collectionName, docId), data);

    showResult(
      "firestoreResult",
      `${
        collectionType === "items" ? "ã‚¢ã‚¤ãƒ†ãƒ " : "ãƒ¦ãƒ¼ã‚¶ãƒ¼"
      }ã‚’è¿½åŠ ã—ã¾ã—ãŸ: ${requiredId} (ID: ${docId})`,
      "success"
    );
    closeModal();
  } catch (error) {
    console.error("ãƒ‡ãƒ¼ã‚¿è¿½åŠ ã‚¨ãƒ©ãƒ¼:", error);
    showResult("firestoreResult", `ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
  }
}

// ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‰Šé™¤é–¢æ•°
async function deleteDocument(collectionName, docId, displayName) {
  if (
    !confirm(`ã€Œ${displayName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)
  ) {
    return;
  }

  try {
    showLoading("firestoreResult");

    // Firestoreã‹ã‚‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
    await deleteDoc(doc(db, collectionName, docId));

    showResult(
      "firestoreResult",
      `ã€Œ${displayName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`,
      "success"
    );

    console.log(
      `Document deleted: ${collectionName}/${docId} (${displayName})`
    );

    // å‰Šé™¤å¾Œã«é©åˆ‡ãªã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’è‡ªå‹•å†è¡¨ç¤º
    setTimeout(() => {
      switch (collectionName) {
        case "items":
          getAllItems();
          break;
        case "users":
          getAllUsers();
          break;
        case "scanItems":
          getAllScanItems();
          break;
        default:
          console.warn(`Unknown collection name: ${collectionName}`);
      }
    }, 1000); // 1ç§’å¾Œã«å†è¡¨ç¤ºï¼ˆçµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹æ™‚é–“ã‚’ç¢ºä¿ï¼‰
  } catch (error) {
    console.error("å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
    showResult("firestoreResult", `å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
  }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
window.addDocument = addDocument;
window.getAllScanItems = getAllScanItems;
  if (!file) {
    showResult("firestoreResult", "ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“", "error");
    return;
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ãƒã‚§ãƒƒã‚¯
  if (!file.name.endsWith(".xlsx") && !file.name.endsWith(".xls")) {
    showResult(
      "firestoreResult",
      "Excel ãƒ•ã‚¡ã‚¤ãƒ« (.xlsx ã¾ãŸã¯ .xls) ã‚’é¸æŠã—ã¦ãã ã•ã„",
      "error"
    );
    return;
  }

  showLoading("firestoreResult");

  try {
    // XLSXãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å‹•çš„ã«ãƒ­ãƒ¼ãƒ‰
    const XLSX = await loadXLSXLibrary();

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å–ã‚Š
    const arrayBuffer = await file.arrayBuffer();
    const workbook = XLSX.read(arrayBuffer, { type: "array" });

    // æœ€åˆã®ã‚·ãƒ¼ãƒˆã‚’å–å¾—
    const firstSheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[firstSheetName];

    // ã‚·ãƒ¼ãƒˆã‚’JSONã«å¤‰æ›ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ä½¿ç”¨ï¼‰
    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

    if (jsonData.length < 2) {
      showResult(
        "firestoreResult",
        "ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¨ãƒ‡ãƒ¼ã‚¿è¡ŒãŒå¿…è¦ã§ã™ã€‚",
        "error"
      );
      return;
    }

    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¨ãƒ‡ãƒ¼ã‚¿è¡Œã‚’åˆ†é›¢
    let headers = jsonData[0];
    const dataRows = jsonData.slice(1);

    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
    console.log("Headers type:", typeof headers);
    console.log("Headers:", headers);
    console.log("Is Array:", Array.isArray(headers));

    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒé…åˆ—ã§ãªã„å ´åˆã¯é…åˆ—ã«å¤‰æ›
    if (!Array.isArray(headers)) {
      if (typeof headers === "object" && headers !== null) {
        headers = Object.values(headers);
        console.log("Converted headers to array:", headers);
      } else {
        showResult("firestoreResult", "ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒä¸æ­£ã§ã™", "error");
        return;
      }
    }

    // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    let expectedHeaders;
    let collectionName;

    if (collectionType === "items") {
      expectedHeaders = [
        "item_no",
        "item_name",
        "category_name",
        "company_name",
        "maker_code",
      ];
      collectionName = "items";
    } else if (collectionType === "users") {
      expectedHeaders = [
        "user_id",
        "user_name",
        "email",
        "phone",
        "department",
        "status",
        "role",
        "print_status",
      ];
      collectionName = "users";
    } else {
      showResult("firestoreResult", "ç„¡åŠ¹ãªã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ã§ã™", "error");
      return;
    }

    // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    const missingHeaders = expectedHeaders.filter(
      (header) => !headers.includes(header)
    );
    if (missingHeaders.length > 0) {
      showResult(
        "firestoreResult",
        `å¿…è¦ãªåˆ—ãŒä¸è¶³ã—ã¦ã„ã¾ã™: ${missingHeaders.join(", ")}\n` +
          `å¿…è¦ãªåˆ—: ${expectedHeaders.join(", ")}\n` +
          `ç¾åœ¨ã®åˆ—: ${headers.join(", ")}`,
        "error"
      );
      return;
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã«ä¿å­˜
    let resultMessage = "";
    let successCount = 0;
    let errorCount = 0;
    const errors = [];

    for (let i = 0; i < dataRows.length; i++) {
      let row = dataRows[i];

      // rowãŒé…åˆ—ã§ãªã„å ´åˆã¯Object.valuesã§é…åˆ—åŒ–
      if (!Array.isArray(row)) {
        if (typeof row === "object" && row !== null) {
          row = Object.values(row);
        } else {
          continue; // ä¸æ­£ãªè¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
        }
      }

      // ç©ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
      if (row.every((cell) => !cell && cell !== 0)) continue;

      try {
        // å¿…è¦ãªé …ç›®ã®ã¿æŠ½å‡ºï¼ˆpriceã¯expectedHeadersã«å«ã‚ãªã„ï¼‰
        const docData = {};
        expectedHeaders.forEach((header) => {
          const headerIndex = headers.indexOf(header);
          if (headerIndex !== -1 && headerIndex < row.length) {
            docData[header] = row[headerIndex] || "";
          } else {
            docData[header] = ""; // ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ç©ºæ–‡å­—
          }
        });

        // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
        if (collectionType === "items" && !docData.item_no) {
          throw new Error(`è¡Œ ${i + 2}: item_no ã¯å¿…é ˆã§ã™`);
        }
        if (collectionType === "users" && !docData.user_id) {
          throw new Error(`è¡Œ ${i + 2}: user_id ã¯å¿…é ˆã§ã™`);
        }

        // UUIDã‚’ç”Ÿæˆã—ã¦Firestoreã«è¿½åŠ 
        const docId = generateUUID();
        const displayId =
          collectionType === "items" ? docData.item_no : docData.user_id;
        console.log(
          `Saving to Firestore: UUID(${docId}) for ${displayId}`,
          docData
        );
        await setDoc(doc(db, collectionName, docId), docData);
        successCount++;
        console.log(`Successfully saved: ${displayId} with UUID ${docId}`);
      } catch (error) {
        console.error(`Error in row ${i + 2}:`, error);
        errorCount++;
        errors.push(`è¡Œ ${i + 2}: ${error.message}`);
      }
    }

    resultMessage += `æˆåŠŸ: ${successCount} ä»¶\n`;

    if (errorCount > 0) {
      resultMessage += `ã‚¨ãƒ©ãƒ¼: ${errorCount} ä»¶\n\n`;
      resultMessage += `ã‚¨ãƒ©ãƒ¼è©³ç´°:\n${errors.slice(0, 10).join("\n")}`;
      if (errors.length > 10) {
        resultMessage += `\n... ãŠã‚ˆã³ ${errors.length - 10} ä»¶ã®ã‚¨ãƒ©ãƒ¼`;
      }
      showResult("firestoreResult", resultMessage, "warning");
    } else {
      showResult("firestoreResult", resultMessage, "success");
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
    fileInput.value = "";
  } catch (error) {
    console.error("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:", error);
    showResult(
      "firestoreResult",
      `ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${error.message}`,
      "error"
    );
    fileInput.value = "";
  }
}

// XLSXãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å‹•çš„ã«ãƒ­ãƒ¼ãƒ‰
async function loadXLSXLibrary() {
  if (window.XLSX) {
    return window.XLSX;
  }

  return new Promise((resolve, reject) => {
    const script = document.createElement("script");
    script.src =
      "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js";
    script.onload = () => {
      resolve(window.XLSX);
    };
    script.onerror = () => {
      reject(new Error("XLSXãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"));
    };
    document.head.appendChild(script);
  });
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
window.addDocument = addDocument;
window.getAllScanItems = getAllScanItems;
window.getAllItems = getAllItems;
window.getAllUsers = getAllUsers;
window.callHelloWorld = callHelloWorld;
window.downloadItemsTemplate = downloadItemsTemplateFromHosting;
window.downloadUsersTemplate = downloadUsersTemplateFromHosting;
window.showResult = showResult;
window.showLoading = showLoading;
window.clearResults = clearResults;
window.deleteDocument = deleteDocument;

// åˆæœŸåŒ–å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
console.log("Firebase ã‚¢ãƒ—ãƒªãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ");
